SELECT 
  c.case_id,
  c.case_number,
  c.prelim_deadline,
  c.inves_deadline,
  c.prelim_status,
  c.inves_status,
  c.prelim_result,
  c.inves_result,
  s.prelim_warning,
  s.invest_warning,
  c.responsible_district,
  c.prelim_investigator,
  c.inves_investigator,
  -- Add computed fields to identify warning types
  CASE 
    WHEN c.prelim_result != 2 AND c.prelim_status != 8 AND c.prelim_deadline IS NOT NULL 
         AND c.prelim_deadline <= CURRENT_DATE + s.prelim_warning * INTERVAL '1 day'
         AND c.prelim_deadline >= CURRENT_DATE 
    THEN 'warning_prelim'
    
    WHEN c.prelim_result = 2 AND c.inves_status != 7 AND c.inves_deadline IS NOT NULL
         AND c.inves_deadline <= CURRENT_DATE + s.invest_warning * INTERVAL '1 day'
         AND c.inves_deadline >= CURRENT_DATE
    THEN 'warning_inves'
    
    WHEN c.prelim_result != 2 AND c.prelim_status != 8 AND c.prelim_deadline IS NOT NULL
         AND c.prelim_deadline < CURRENT_DATE
    THEN 'late_prelim'
    
    WHEN c.prelim_result = 2 AND c.inves_status != 7 AND c.inves_deadline IS NOT NULL
         AND c.inves_deadline < CURRENT_DATE
    THEN 'late_inves'
  END as warning_type
FROM public.case c
JOIN public.settings s ON s.id = 1
WHERE (
  -- Warning prelim conditions
  (c.prelim_result != 2 AND c.prelim_status != 8 AND c.prelim_deadline IS NOT NULL 
   AND c.prelim_deadline <= CURRENT_DATE + s.prelim_warning * INTERVAL '1 day'
   AND c.prelim_deadline >= CURRENT_DATE)
  OR
  -- Warning inves conditions  
  (c.prelim_result = 2 AND c.inves_status != 7 AND c.inves_deadline IS NOT NULL
   AND c.inves_deadline <= CURRENT_DATE + s.invest_warning * INTERVAL '1 day'
   AND c.inves_deadline >= CURRENT_DATE)
  OR
  -- Late prelim conditions
  (c.prelim_result != 2 AND c.prelim_status != 8 AND c.prelim_deadline IS NOT NULL
   AND c.prelim_deadline < CURRENT_DATE)
  OR
  -- Late inves conditions
  (c.prelim_result = 2 AND c.inves_status != 7 AND c.inves_deadline IS NOT NULL
   AND c.inves_deadline < CURRENT_DATE)
) AND (
  COALESCE({{ Slc_Division.selectedOptionValue }}, 0) = 0
  OR (c.responsible_district != '' AND CAST(c.responsible_district AS INTEGER) = {{ Slc_Division.selectedOptionValue }})
)
ORDER BY c.year, c.case_number;