SELECT 
    case_id, case_number, case_type, received_date, prelim_status, prelim_result, 
    prelim_extension, inves_status, inves_result, inves_extension, responsible_district, 
    offense_base, prelim_deadline, inves_deadline, year, book_date_213, 
    book_sign_date_213, book_date_644, source, prelim_investigator, damage_value, inves_investigator,
    
    -- Background color logic with proper type casting and date calculations
    CASE 
        WHEN case_type::INTEGER = 2 THEN '#eeefef'
        WHEN prelim_result::INTEGER != 2 THEN
            CASE 
                WHEN prelim_status::INTEGER = 8 OR (prelim_result::INTEGER != 0 AND prelim_result::INTEGER != 1) THEN '#27ae60'
                WHEN prelim_deadline IS NOT NULL AND (prelim_deadline - CURRENT_DATE) BETWEEN 0 AND 15 THEN '#fff3cd'
                WHEN prelim_deadline IS NOT NULL AND prelim_deadline < CURRENT_DATE THEN '#d9534f'
                ELSE '#ffffff'
            END
        WHEN prelim_result::INTEGER = 2 THEN
            CASE 
                WHEN inves_status::INTEGER = 7 THEN '#27ae60'
                WHEN inves_deadline IS NOT NULL AND (inves_deadline - CURRENT_DATE) BETWEEN 0 AND 180 THEN '#fff3cd'
                WHEN inves_deadline IS NOT NULL AND inves_deadline < CURRENT_DATE THEN '#d9534f'
                ELSE '#ffffff'
            END
        ELSE '#ffffff'
    END AS background_color,
    
    -- Text color logic (white for red backgrounds, black for others)
    CASE 
        WHEN (prelim_deadline IS NOT NULL AND prelim_deadline < CURRENT_DATE) OR
             (inves_deadline IS NOT NULL AND inves_deadline < CURRENT_DATE)
        THEN '#ffffff'
        ELSE '#000000'
    END AS text_color
    
FROM 
    public."case" c
WHERE
    CASE 
        WHEN {{ String(Slc_Division.selectedOptionValue) }} = '0' THEN TRUE
        ELSE c.responsible_district = {{ String(Slc_Division.selectedOptionValue) }}::TEXT
    END
ORDER BY 
    c.received_date DESC NULLS LAST;